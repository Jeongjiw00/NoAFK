<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/myteam.css" />
    <script
      src="https://code.jquery.com/jquery-3.6.3.js"
      integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
      crossorigin="anonymous"
    ></script>
    <title>my team</title>
  </head>
  <body>
    <main id="myteam-main">
      <section>
        <div id="myteam-title"><h1>{{teamName}}</h1></div>
      </section>
      <section id="myteam__membaerList">
        <table>
          <thead>
            <tr>
              <th>번호</th>
              <th>이름</th>
              <th>참가일</th>
              <th>직책</th>
              <th>담당업무</th>
              <th>귓속말</th>
              <th>설정</th>
            </tr>
          </thead>
          <tbody>
            {% set position = ['신청자', '팀원', '부리더', '리더'] %} {% for
            member in memberListHasNickname %} {% if member.position !== 0 %}
            <tr id="row-{{member.id}}">
              <th>{{member.id}}</th>
              <th>{{member.nickname}}</th>
              <th>{{member.createdAt}}</th>

              <th
                class="myteam__memberList__position"
                data-value="{{member.position}}"
              >
                {{position[member.position]}}
              </th>

              <th class="myteam__memberList__task">{{member.task}}</th>
              <th><button class="myteam__memberList__chat">귓속말</button></th>
              <th>
                <button
                  class="myteam__memberList__update"
                  onclick="updateMember({{member.id}})"
                >
                  수정</button
                ><button
                  class="myteam__memberList__emit"
                  onclick="emitMember({{member.id}})"
                >
                  방출
                </button>
              </th>
            </tr>
            {% endif %} {% endfor %}
          </tbody>
        </table>
      </section>
      <section id="myteam__searching-new">
        <div>
          <input id="inputUserNickname" type="text" /><span>팀원 추가하기</span
          ><button id="addNewMemberBtn">+</button>
        </div>
      </section>
      <section id="myteam__project-status">
        <h2 id="myteam__project-status__title">프로젝트 현재 진행 상태</h2>
        <div id="myteam__project-status__buttons">
          <button class="status-btn" data-num="0" onclick="updateTeamStatus(0)">
            모집마감</button
          ><span class="myteam__project-status__arrow">➡️</span
          ><button
            class="status-btn"
            data-num="1"
            onclick="updateTeamStatus(1)"
          >
            준비</button
          ><span class="myteam__project-status__arrow">➡️</span
          ><button
            class="status-btn"
            data-num="2"
            onclick="updateTeamStatus(2)"
          >
            진행중</button
          ><span class="myteam__project-status__arrow">➡️</span
          ><button
            class="status-btn"
            data-num="3"
            onclick="updateTeamStatus(3)"
          >
            테스트</button
          ><span class="myteam__project-status__arrow">➡️</span
          ><button
            class="status-btn"
            data-num="4"
            onclick="updateTeamStatus(4)"
          >
            프로젝트 종료
          </button>
        </div>
      </section>

      <section id="myteam__project-status__footer">
        <div>
          <button id="deleteTeam" onclick="updateTeamStatus(5)">팀 삭제</button>
          <button>팀 채팅</button>
        </div>
      </section>
    </main>
    <script>
      let nowStatus = document.querySelector(
        '.status-btn[data-num="{{projectStatus}}"]'
      );
      console.log(nowStatus);
      nowStatus.classList.add('now_team_status');

      const url = window.location.pathname;
      const inputUserNickname = document.querySelector('#inputUserNickname');
      const addNewMemberBtn = document.querySelector('#addNewMemberBtn');
      addNewMemberBtn.addEventListener('click', () => {
        const nickname = inputUserNickname.value;
        inputUserNickname.value = '';
        const position = 1;
        console.log(nickname, position);

        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            nickname,
            position,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            location.reload;
          });
      });

      function updateTeamStatus(status) {
        fetch(url, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            status,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.updatedTeamStatus.message);
            console.log(data.updatedTeamStatus.status);
            nowStatus.classList.remove('now_team_status');
            nowStatus = document.querySelector(
              `.status-btn[data-num="${num}"]`
            );
            nowStatus.classList.add('now_team_status');
          });
      }

      function updateMember(memberId) {
        const tr = document.querySelector(`#row-${memberId}`);
        console.log(tr);
      }

      function emitMember(memberId) {
        fetch(url + `/${memberId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({}),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(`${memberId}번 팀원을 삭제했습니다.`);
            location.reload;
          });
      }
    </script>
  </body>
</html>
